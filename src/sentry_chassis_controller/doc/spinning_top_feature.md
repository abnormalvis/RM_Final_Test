# 小陀螺功能使用说明

## 功能概述
新的小陀螺功能实现了真正的"恒定平移方向，同时自转"运动模式。在这个模式下，底盘会进行持续自转，但每次平移运动时都保持一个固定的方向，不会因自转而改变平移路径。

## 核心特性
- **方向锁定**：一旦设置平移方向，自转不会改变该方向
- **独立控制**：平移方向和自转速度完全独立控制
- **场-centric兼容**：支持世界坐标系和底盘坐标系两种模式
- **平滑过渡**：模式切换平滑，不会造成底盘急停

## 控制键位
在原有的WASD+QE基础上，新增：`T` 键

| 按键 | 普通模式 | 小陀螺模式 |
|------|----------|------------|
| W/A/S/D | 直接平移 | 设置平移方向 |
| Q/E | 旋转 | 旋转（保持平移方向） |
| C | 停止全部 | 只停止平移，保持旋转 |
| T | 切换小陀螺模式 | 关闭小陀螺模式 |
| F | 切换坐标系模式 | 仍然支持 |

## 使用步骤

### 1. 启动测试
```bash
roslaunch sentry_chassis_controller sentry_spinning_top_test.launch
```

### 2. 基本操作

#### 方法1：先运动再进入小陀螺模式
1. 按 `W` / `A` / `S` / `D` 进行普通平移
2. 按 `T` 进入小陀螺模式
3. 按 `Q` / `E` 持续自转
4. 底盘将以当前方向持续平移，同时自转

#### 方法2：先进入模式再设置运动
1. 按 `T` 进入小陀螺模式
2. 按 `W` / `A` / `S` / `D` 设置平移方向
3. 按 `Q` / `E` 进行自转
4. 底盘将按设定方向平移，同时自转

### 3. 高级技巧
- **快慢控制**：`Shift` + 方向键可以加速平移
- **持续自转**：长按 `Q` / `E` 键或使用Shift组合键加速
- **停止技巧**：
  - `C` 键：只停止平移，保持自转
  - 先反复按QE键让角速度为0，再按T关闭模式

### 4. 模式切换
- 在任何时候按 `T` 可以开启或关闭小陀螺模式
- 模式切换时会保持现有的运动状态，不会造成急停
- 关闭小陀螺模式后，底盘会恢复到普通控制模式

## 参数调节
小陀螺模式在配置文件中对PID参数进行了特别优化：

- **转向响应**：更快的转向PID参数，减少在自转过程中的方向偏差
- **速度控制**：增加积分项消除长期稳态误差，提升方向保持精度

如有需要可以在`sentry_spinning_top_test.launch`中进一步调整：
- `walk_vel`：普通平移速度
- `run_vel`：加速模式速度
- `yaw_rate`：自转速度
- `yaw_rate_run`：自转加速度
- `hz`：控制频率

## 常见问题

**问题：进入小陀螺模式后底盘不动？**
解答：需要先设置平移方向和自转角速度，小陀螺模式只是锁定平移方向。

**问题：感觉方向不够精准？**
解答：检查底盘是否完全启动，或适当调整PID参数。

**问题：模式切换时底盘跳动？**
解答：这是正常现象，模式切换时运动指令的计算方式发生了改变。

## 实现原理 (技术细节)
程序在内存中使用极坐标方式存储平移状态：
- `translation_magnitude`：平移速度大小
- `translation_angle`：平移方向角度
- `cur_ang`：自转角速度

在发布速度指令时，根据当前底盘姿态将极坐标转换回笛卡尔坐标，因此可以确保无论底盘如何自转，平移方向始终保持固定。

## 代码结构
小陀螺模式的核心实现在`sentry_control_key.cpp`：
- 状态存储：L155-L158
- 运动处理：L173-L272
- 速度计算：L276-L326
- 模式切换：L248-L265

该实现与原有的逆运动学解算完全兼容，不需要修改控制器和电机驱动层代码。