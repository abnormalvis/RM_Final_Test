# 键盘同时平移旋转功能说明

## ✨ 新增功能

现在键盘控制支持**同时进行平移和旋转**！

### 之前的限制

- ❌ 按 W/A/S/D：只能平移，不能旋转
- ❌ 按 Q/E：只能旋转，不能平移
- ❌ 平移和旋转互斥，无法同时进行

### 现在的能力

- ✅ **W+Q**：向前移动 + 左转（边走边转）
- ✅ **A+E**：向左平移 + 右转（横移同时旋转）
- ✅ **W+A+Q**：斜向前进 + 左转（组合移动）
- ✅ 支持任意平移和旋转的组合

## 🎮 控制方式

### 基础按键（单独按下）

| 按键 | 功能 | 说明 |
|------|------|------|
| **W** | 向前移动 | 底盘坐标系 +X 方向 |
| **S** | 向后移动 | 底盘坐标系 -X 方向 |
| **A** | 向左平移 | 底盘坐标系 +Y 方向 |
| **D** | 向右平移 | 底盘坐标系 -Y 方向 |
| **Q** | 左转 | 逆时针旋转 |
| **E** | 右转 | 顺时针旋转 |
| **C** | 停止 | 立即停止所有运动 |
| **Shift+方向键** | 加速 | 速度从 `walk_vel` 提升到 `run_vel` |

### 组合按键（同时按下）

#### 1. 斜向移动（WASD 组合）

| 组合 | 方向 | 示例 |
|------|------|------|
| **W+A** | 左前方 45° | 斜向移动 |
| **W+D** | 右前方 45° | 斜向移动 |
| **S+A** | 左后方 45° | 斜向移动 |
| **S+D** | 右后方 45° | 斜向移动 |

**注意**：斜向速度会自动归一化，防止 √2 倍速度。

#### 2. 边移动边旋转（方向 + 旋转）

| 组合 | 动作 | 应用场景 |
|------|------|---------|
| **W+Q** | 向前 + 左转 | 转弯前进 |
| **W+E** | 向前 + 右转 | 转弯前进 |
| **A+Q** | 向左平移 + 左转 | 横移同时调整方向 |
| **D+E** | 向右平移 + 右转 | 横移同时调整方向 |
| **S+Q** | 向后 + 左转 | 倒车转向 |
| **W+A+Q** | 左前方 + 左转 | 复杂机动 |

#### 3. 小陀螺模式示例

| 组合 | 效果 | 说明 |
|------|------|------|
| **W+Q** | 顺圈前进 | 沿圆弧前进（逆时针） |
| **A+Q** | 绕圈平移 | 保持面向前方，逆时针绕圈 |
| **单独 Q** | 原地左转 | 经典小陀螺 |

## 🔧 技术实现

### 1. 按键状态持久化

```cpp
// 按键状态变量（外部作用域，持续有效）
bool key_w = false, key_s = false, key_a = false, key_d = false;
bool key_q = false, key_e = false;
```

- 按下按键 → 设置为 `true`
- 互斥按键 → 自动清除对立按键（例如 W 清除 S）
- 按 C 停止 → 所有按键清零
- 超时自动清零 → 0.5 秒无新按键则清零（防止按键卡住）

### 2. 速度累加

```cpp
// 平移速度累加
if (key_w) cur_vx_world += linear_speed;
if (key_s) cur_vx_world -= linear_speed;
if (key_a) cur_vy_world += linear_speed;
if (key_d) cur_vy_world -= linear_speed;

// 旋转速度（独立于平移）
if (key_q) cur_omega += omega_speed;
if (key_e) cur_omega -= omega_speed;
```

- **平移和旋转独立计算**，然后组合发布
- 支持多按键效果叠加

### 3. 斜向速度归一化

```cpp
// 防止 W+A 时速度变成 √2 倍
double speed_magnitude = std::sqrt(cur_vx_world * cur_vx_world + cur_vy_world * cur_vy_world);
if (speed_magnitude > linear_speed * 1.01) {
    double scale = linear_speed / speed_magnitude;
    cur_vx_world *= scale;
    cur_vy_world *= scale;
}
```

- W+A 组合时：速度保持为 `linear_speed`，不会超速
- 方向：45° 斜向

### 4. 互斥关系

```
前后互斥：W ⇄ S（同时按下，后按的生效）
左右互斥：A ⇄ D
左转右转互斥：Q ⇄ E

但平移和旋转不互斥：
  W/A/S/D 可以与 Q/E 同时按下 ✅
```

### 5. 超时保护

```cpp
// 0.5 秒无新按键 → 清零所有状态
if ((now - last_key_time).toSec() > 0.5) {
    key_w = key_s = key_a = key_d = false;
    key_q = key_e = false;
}
```

- 防止终端失去焦点时按键状态残留
- 防止网络延迟导致的速度累积

## 📊 对比示例

### 场景 1：前进并左转（W+Q）

**之前**：
```
按 W → 只能前进，无法转向
松开 W，按 Q → 停止前进，开始旋转
❌ 无法实现转弯前进
```

**现在**：
```
同时按 W+Q → 边前进边左转
效果：沿圆弧路径前进（类似汽车转弯）
✅ 一次操作完成复杂机动
```

### 场景 2：横移并调整方向（A+E）

**之前**：
```
按 A → 向左平移，但朝向不变
需要先松开 A，再按 E 调整朝向
❌ 分步操作，不流畅
```

**现在**：
```
同时按 A+E → 向左平移的同时右转
效果：底盘横移，同时调整面向目标方向
✅ 适合对抗场景中的快速调整
```

### 场景 3：小陀螺攻击（W+Q 持续）

**之前**：
```
只能选择：
  - 原地旋转（Q）：无位移，容易被预判
  - 直线前进（W）：方向固定，易被打击
❌ 无法同时进行
```

**现在**：
```
持续按 W+Q → 沿螺旋路径前进
效果：
  - 保持移动（难瞄准）
  - 持续旋转（暴露不同装甲板）
  - 路径不可预测
✅ 经典小陀螺战术
```

## 🎯 实战技巧

### 1. 转弯前进

```
W+Q（左转）或 W+E（右转）
→ 适合沿圆弧路径接近目标
→ 类似汽车转弯
```

### 2. 侧身射击

```
A/D（横移） + Q/E（调整枪口朝向）
→ 横向移动躲避弹道
→ 同时保持枪口指向敌人
```

### 3. 环绕敌人

```
A+Q 或 D+E（绕圈）
→ 保持与敌人的距离
→ 持续旋转寻找弱点装甲板
```

### 4. 撤退掩护

```
S（后退） + Q/E（扫视）
→ 后退的同时观察追击者
→ 寻找反击机会
```

## ⚙️ 配置参数

在 `teleop_feature.yaml` 中调整：

```yaml
sentry_control_key_feature:
  walk_vel: 0.5        # 正常移动速度（m/s）
  run_vel: 1.0         # Shift 加速后速度（m/s）
  default_omega: 1.0   # 旋转速度（rad/s）
  hz: 10               # 控制频率（Hz）
  velocity_mode: "global"  # 速度坐标系模式
```

**推荐配置**：
- `walk_vel: 0.5`：适合精确控制
- `run_vel: 1.0`：快速机动
- `default_omega: 1.0`：57.3°/s 旋转速度（平衡灵活性和稳定性）

## 🐛 常见问题

### Q1: 按键松开后还在动？

**A**: 检查超时时间是否太长。默认 0.5 秒自动停止。
```cpp
double key_timeout = 0.5; // 在 keyLoop() 中调整
```

### Q2: 斜向移动速度变慢了？

**A**: 这是正常的速度归一化。W+A 的速度 = `linear_speed`，不是 √2 倍。
如果需要更快，按 Shift 加速。

### Q3: 同时按 W+S 会怎样？

**A**: 后按的键生效（互斥）。例如：
- 先按 W，再按 S → 后退（S 生效）
- 先按 S，再按 W → 前进（W 生效）

### Q4: Q 和 E 可以同时按吗？

**A**: 可以，但互斥。后按的生效。
- 先按 Q，再按 E → 右转
- 先按 E，再按 Q → 左转

### Q5: 如何实现精确的小陀螺？

**A**: 调整旋转速度：
```yaml
default_omega: 0.5   # 慢速旋转（更精确）
default_omega: 2.0   # 快速旋转（更激进）
```

## 📝 开发说明

### 修改内容

1. **按键状态持久化**：从 `switch` 内的单次处理改为外部状态变量
2. **速度累加**：支持多按键效果叠加
3. **互斥处理**：前后/左右/左转右转 互斥
4. **超时保护**：0.5 秒无新按键自动清零
5. **速度归一化**：斜向移动速度不超过 `linear_speed`

### 代码位置

- 文件：`src/sentry_chassis_controller/src/sentry_control_key_feature.cpp`
- 关键函数：`TeleopTurtle::keyLoop()`
- 行数：约 170-330 行

## 🚀 测试步骤

1. 重新编译：
```bash
cd /home/idris/final_ws
catkin build sentry_chassis_controller
source devel/setup.bash
```

2. 启动仿真：
```bash
roslaunch sentry_chassis_controller sentry_with_odom_feature.launch
```

3. 测试按键组合：
```
单独按 W → 前进
单独按 Q → 左转
同时按 W+Q → 边前进边左转 ✅
按 C → 立即停止
```

4. 观察终端日志：
```
mode=global frame=odom yaw(odom)=0.123 world=(1.00,0.00) -> body=(0.99,0.12)
```

## 🎓 总结

- ✅ **平移 + 旋转可以同时进行**
- ✅ **支持任意方向组合**（W+A、W+D、S+A、S+D）
- ✅ **斜向速度自动归一化**（不会超速）
- ✅ **超时自动停止**（0.5 秒保护）
- ✅ **适合小陀螺、绕圈、转弯等战术**

现在可以自由组合平移和旋转，实现更灵活的底盘控制！🎉
