# 底盘自锁功能改进总结

> 日期：2025-11-30  
> 分支：develop-selflock → main  
> 状态：已完成并测试

---

## 1. 问题背景

### 1.1 原有问题现象

在第一版自锁功能实现后，用户反馈以下问题：

1. **轮向电机前后抖动**：自锁激活后轮子在 +2~3 rad/s 和 -2~3 rad/s 之间震荡
2. **底盘缓慢漂移**：底盘会向后倒退然后又前进，反复循环
3. **里程计漂移**：odom 的 yaw 从 0 漂移到 3.x 弧度，x/y 位置也出现漂移

### 1.2 原因分析

第一版自锁采用**速度锁定**方案：
- 将目标轮速设为 0，由速度 PID 控制器维持
- **问题**：在斜坡上，重力导致轮子被迫转动，速度 PID 输出力矩抵抗但会导致反向运动
- **结果**：PID 反复纠正 → 产生震荡 → 里程计累积漂移

---

## 2. 自锁方案总览

现在支持三种自锁模式：

| 模式 | 参数配置 | 原理 | 优点 | 缺点 |
|------|----------|------|------|------|
| **速度锁定** | `lock_position=false`<br>`geo_lock_enabled=false` | 目标速度=0，速度PID控制 | 实现简单 | 斜坡上震荡 |
| **位置锁定** | `lock_position=true`<br>`geo_lock_enabled=false` | 记录锁定位置，位置PD控制 | 斜坡稳定 | 需要持续输出力矩 |
| **几何自锁** | `geo_lock_enabled=true` | 舵轮转到自转切向，利用滑动摩擦 | 结构抵抗，省力 | 切换需转向时间 |

**优先级**：`geo_lock_enabled` > `lock_position` > 速度锁定

---

## 3. 位置锁定模式

### 3.1 工作原理

```
进入自锁时：
  记录当前轮子位置 → locked_wheel_pos_[i]

自锁状态下：
  位置误差 = locked_wheel_pos_[i] - 当前轮子位置
  锁定力矩 = P * 位置误差 - D * 当前轮速
  直接输出力矩（绕过速度PID）
```

### 3.2 优势

- 位置误差越大，输出力矩越大，能有效抵抗重力
- D 项提供阻尼，防止振荡
- 不经过速度 PID，避免积分项累积导致的问题

---

## 4. 几何自锁模式（新增）

### 4.1 原理说明

几何自锁利用底盘的机械结构来抵抗外力，而不是依靠电机持续输出力矩。

**核心思想**：将 4 个舵轮转到底盘**自转的切向方向**（形成"X"字或旋转姿态）

```
                    ↑ x (前)
                    |
        FL ↗       |       ↖ FR
              \    |    /
               \   |   /
    ← y --------[中心]-------- → -y
               /   |   \
              /    |    \
        RL ↙       |       ↘ RR
                    |
                    ↓ -x (后)

舵角方向：每个轮子指向底盘中心的切线方向（逆时针旋转方向）
```

### 4.2 力学分析

当舵轮呈自转切向布局时：

1. **任意平移方向的外力**（如推底盘向前/后/左/右）都与轮子的滚动方向**垂直**
2. 轮子只能**侧滑**（滑动摩擦）而不能**滚动**（滚动摩擦）
3. **滑动摩擦系数** μ_s ≈ 0.5~0.8 **远大于** **滚动摩擦系数** μ_r ≈ 0.01~0.05
4. 因此底盘能有效抵抗外部扰动，实现**结构自锁**

### 4.3 舵角计算

对于轮子位置 (rx, ry) 相对于底盘中心：

```
切向方向（逆时针）：θ = atan2(rx, -ry)
```

对于标准布局（wheel_base = wheel_track = 0.36m）：

| 轮子 | 位置 (rx, ry) | 几何自锁舵角 |
|------|---------------|--------------|
| FL (左前) | (+0.18, +0.18) | atan2(+0.18, -0.18) = **-45°** |
| FR (右前) | (+0.18, -0.18) | atan2(+0.18, +0.18) = **+45°** |
| RL (左后) | (-0.18, +0.18) | atan2(-0.18, -0.18) = **-135°** |
| RR (右后) | (-0.18, -0.18) | atan2(-0.18, +0.18) = **+135°** |

### 4.4 轮子制动选项

几何自锁时，轮子可以选择：

| `geo_lock_wheel_brake` | 行为 | 适用场景 |
|------------------------|------|----------|
| `true`（默认） | 同时使用位置PD锁定轮子 | 需要最大稳定性 |
| `false` | 轮子自由滚动，仅依靠滑动摩擦 | 省电，依靠结构 |

---

## 5. 代码修改详情

### 5.1 头文件新增变量

**文件**：`include/sentry_chassis_controller/wheel_pid_controller.hpp`

```cpp
// ==================== 几何自锁模式 ====================
bool geo_lock_enabled_{false};         // 几何自锁模式开关
double geo_lock_angles_[4]{};          // 几何自锁时的目标舵角（预计算）
bool geo_lock_wheel_brake_{true};      // 几何自锁时是否同时锁定轮子
```

### 5.2 init() 函数新增

**文件**：`src/wheel_pid_controller.cpp`

```cpp
// 几何自锁参数读取
controller_nh.param("self_lock/geo_lock_enabled", geo_lock_enabled_, false);
controller_nh.param("self_lock/geo_lock_wheel_brake", geo_lock_wheel_brake_, true);

// 预计算几何自锁舵角
double rx = wheel_base_ / 2.0;
double ry = wheel_track_ / 2.0;
geo_lock_angles_[0] = std::atan2(rx, -ry);   // FL: -45°
geo_lock_angles_[1] = std::atan2(rx, ry);    // FR: +45°
geo_lock_angles_[2] = std::atan2(-rx, -ry);  // RL: -135°
geo_lock_angles_[3] = std::atan2(-rx, ry);   // RR: +135°
```

### 5.3 update() 函数自锁逻辑

```cpp
if (geo_lock_enabled_)
{
    // ========== 几何自锁模式 ==========
    // 设置舵角为预计算的几何自锁角度
    for (int i = 0; i < 4; ++i)
    {
        pivot_cmd_[i] = geo_lock_angles_[i];
    }
    
    // 轮子控制：可选是否锁定
    if (geo_lock_wheel_brake_)
    {
        // 使用位置PD锁定轮子
        // ... 位置PD控制代码 ...
    }
    else
    {
        // 轮子自由（目标速度=0）
        for (int i = 0; i < 4; ++i)
            wheel_cmd_[i] = 0.0;
    }
}
```

---

## 6. 配置参数

**文件**：`config/wheel_pid_params.yaml`

```yaml
self_lock:
  # 基本参数
  enabled: true           # 自锁功能开关
  idle_timeout: 0.5       # 空闲超时（秒）
  velocity_deadband: 0.05 # 速度死区（m/s）
  
  # 位置锁定参数
  lock_position: true     # 位置锁定开关
  lock_pos_p: 8.0         # P 增益（5.0~15.0）
  lock_pos_i: 0.0         # I 增益（建议 0）
  lock_pos_d: 1.0         # D 增益（0.5~2.0）
  
  # 几何自锁参数（新增）
  geo_lock_enabled: false     # 几何自锁开关（优先级高于位置锁定）
  geo_lock_wheel_brake: true  # 几何自锁时是否锁定轮子
```

---

## 7. 使用建议

### 7.1 模式选择指南

| 场景 | 推荐模式 | 理由 |
|------|----------|------|
| 平地静止 | 位置锁定 | 响应快，稳定 |
| 斜坡停车 | 位置锁定 或 几何自锁+制动 | 抵抗重力 |
| 长时间静止（省电） | 几何自锁（无轮子制动） | 依靠结构，减少电机功耗 |
| 需要快速响应 | 位置锁定 | 舵角保持原位，解锁即可运动 |

### 7.2 测试方法

启用几何自锁测试：

```yaml
# wheel_pid_params.yaml
self_lock:
  geo_lock_enabled: true
  geo_lock_wheel_brake: true  # 或 false 测试纯结构自锁
```

观察日志：
```
底盘自锁已激活(几何自锁)：舵角转到自转切向 [-45.0°, 45.0°, -135.0°, 135.0°]，轮子制动=是
```

---

## 8. 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `wheel_pid_controller.hpp` | 修改 | 新增几何自锁变量 |
| `wheel_pid_controller.cpp` | 修改 | 新增几何自锁逻辑分支 |
| `wheel_pid_params.yaml` | 修改 | 新增几何自锁配置参数 |

---

## 9. 后续优化建议

1. **平滑过渡**：在切换到几何自锁时，舵角平滑插值而非突变
2. **动态切换**：通过 dynamic_reconfigure 或话题实时切换模式
3. **自动选择**：根据 IMU 检测斜坡倾角自动选择最佳模式
4. **能耗监控**：比较不同模式的电机功耗

---

*文档更新时间：2025-11-30*
