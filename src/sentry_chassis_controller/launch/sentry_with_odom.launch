<launch>
  <!-- Launch args for rosbag recording -->
  <arg name="bag_topic" default="/odom"/>
  <arg name="bag_dir" default="/home/idris/final_ws/src/sentry_chassis_controller/bags"/>

  <!-- Start full simulation + controllers -->
  <include file="$(find sentry_chassis_controller)/launch/sentry_pid_test_fixed.launch"/>

  <!-- Start forward kinematics node to compute odometry from joint_states -->
  <node pkg="sentry_chassis_controller" type="forward_kinematics" name="forward_kinematics" output="screen">
    <param name="wheel_base" value="0.36"/>
    <param name="wheel_track" value="0.36"/>
    <param name="wheel_radius" value="0.05"/>
  </node>

  <!-- Control whether to resolve inline (inside teleop) or via standalone chassis_controller -->
  <arg name="inline_resolver" default="true"/>

  <!-- Keyboard teleop: now can also publish /cmd_vel_final inline -->
  <node pkg="sentry_chassis_controller" type="sentry_control_key" name="sentry_control_key" output="screen">
    <!-- Dual-mode keyboard parameters -->
    <param name="linear_topic" value="/cmd_vel_linear_absolute"/>
    <param name="angular_topic" value="/cmd_vel_angular_direct"/>
    <param name="merged_topic" value="/cmd_vel"/>
    <param name="frame_id" value="odom"/>
    <param name="odom_frame" value="odom"/>
    <param name="base_frame" value="base_link"/>
    <param name="publish_rate_hz" value="20"/>
    <param name="release_timeout" value="0.25"/>
    <param name="publish_zero_when_idle" value="false"/>
    <param name="linear_speed" value="0.5"/>
    <param name="linear_speed_run" value="1.0"/>
    <param name="angular_speed" value="1.0"/>
    <param name="angular_speed_run" value="1.5"/>
    <param name="forward_cmd_vel_final" value="true"/>
    <param name="inline_resolver" value="$(arg inline_resolver)"/>
  </node>

  <!-- Rotation-matrix resolver (方案A): consume separated topics and publish base-frame velocities -->
  <node pkg="sentry_chassis_controller" type="chassis_controller" name="chassis_controller" output="screen" unless="$(arg inline_resolver)">
    <param name="odom_frame" value="odom"/>
    <param name="base_frame" value="base_link"/>
  </node>

  <!-- rosbag record launched by roslaunch, configurable via args -->
  <!-- Ensure bag dir exists and then start rosbag recording (uses bash -lc to run mkdir + rosbag) -->
  <!-- node pkg="rosbag" type="record" name="rosbag_record" output="screen" launch-prefix="/bin/bash -lc">
    <args>mkdir -p $(arg bag_dir) && rosbag record -O $(arg bag_dir)/odom $(arg bag_topic)</args>
  </node> -->

</launch>
