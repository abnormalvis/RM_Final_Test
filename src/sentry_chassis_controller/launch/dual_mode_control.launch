<?xml version="1.0"?>
<!--
双模式解耦控制器启动文件 - 更新版本
参考 sentry_with_odom.launch 结构进行修改
支持旋转时平移运动而不出现螺旋线运动
基于 rotation_matrix_chassis_application.md 文档实现
-->
<launch>
  <!-- Launch args for rosbag recording -->
  <arg name="bag_topic" default="/odom"/>
  <arg name="bag_dir" default="/home/idris/final_ws/src/sentry_chassis_controller/bags"/>
  <arg name="rviz" default="false"/>

  <!-- Start full simulation + controllers -->
  <include file="$(find sentry_chassis_controller)/launch/sentry_pid_test_fixed.launch"/>

  <!-- Start forward kinematics node to compute odometry from joint_states -->
  <node pkg="sentry_chassis_controller" type="forward_kinematics" name="forward_kinematics" output="screen">
    <param name="wheel_base" value="0.36"/>
    <param name="wheel_track" value="0.36"/>
    <param name="wheel_radius" value="0.05"/>
  </node>

  <!-- 双模式键盘控制器 - Python 版本 -->
  <node pkg="sentry_chassis_controller" type="dual_mode_keyboard_controller.py" name="dual_mode_keyboard_controller" output="screen">
    <!-- 速度参数调整为与 sentry_control_key 相同的数值 -->
    <param name="linear_speed" value="1.0"/>        <!-- 平移速度 (m/s) -->
    <param name="run_linear_speed" value="1.0"/>    <!-- 加速模式线性速度 -->
    <param name="angular_speed" value="1.0"/>       <!-- 角速度 (rad/s) -->
    <param name="run_angular_speed" value="1.5"/>   <!-- 加速模式角速度 -->
    <param name="publish_rate" value="20"/>         <!-- 发布频率 (Hz) -->
  </node>

  <!-- 双模式底盘控制器 - C++ 版本 -->
  <node pkg="sentry_chassis_controller" type="dual_mode_chassis_controller" name="dual_mode_chassis_controller" output="screen">
    <!-- 坐标系参数 -->
    <param name="odom_frame" value="odom"/>
    <param name="base_frame" value="base_link"/>
    <param name="control_loop_rate" value="20.0"/>  <!-- 控制循环频率 (Hz) -->
    <param name="tf_timeout" value="0.2"/>          <!-- TF查找超时时间 (s) -->
  </node>

  <!-- 发布合并后的速度指令到实际控制 -->
  <node pkg="topic_tools" type="relay" name="velocity_command_relay" args="/cmd_vel_merged /cmd_vel"/>

  <!-- 可选：速度可视化 -->
  <group if="$(arg rviz)">
    <node pkg="rqt_robot_steering" type="rqt_robot_steering" name="rqt_robot_steering" output="screen"
          if-exists="rqt_robot_steering">
      <remap from="/cmd_vel" to="/cmd_vel_merged"/>
    </node>
  </group>

  <!-- rosbag record setup (commented out by default) -->
  <!-- node pkg="rosbag" type="record" name="rosbag_record" output="screen" launch-prefix="/bin/bash -lc">
    <args>mkdir -p $(arg bag_dir) && rosbag record -O $(arg bag_dir)/odom $(arg bag_topic)</args>
  </node> -->
</launch>